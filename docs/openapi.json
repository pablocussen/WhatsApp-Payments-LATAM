{
  "openapi": "3.1.0",
  "info": {
    "title": "WhatPay API",
    "description": "Plataforma de pagos peer-to-peer integrada con WhatsApp para Chile.\n\n## Autenticación\nLa mayoría de endpoints requieren JWT Bearer token obtenido en `POST /users/login`.\n\n## Flujo de usuario\n1. Registro vía WhatsApp bot (conversacional)\n2. `POST /users/register` → verifica RUT + crea PIN\n3. `POST /users/login` → PIN → JWT\n4. `POST /topup/webpay` → recarga wallet\n5. `POST /payments/pay` → envía pago P2P\n\n## Niveles KYC\n- `BASIC` — hasta $50.000/tx, $200.000/mes\n- `INTERMEDIATE` — hasta $500.000/tx, $2.000.000/mes\n- `FULL` — hasta $2.000.000/tx\n",
    "version": "0.1.0",
    "contact": {
      "name": "Pablo Cussen",
      "url": "https://cussen.cl",
      "email": "pablo@cussen.cl"
    },
    "license": {
      "name": "Privado — Portfolio Project",
      "url": "https://cussen.cl/whatpay"
    }
  },
  "servers": [
    {
      "url": "https://whatpay-api-930472612593.southamerica-west1.run.app",
      "description": "Producción (GCP Cloud Run — Santiago)"
    },
    {
      "url": "http://localhost:3000",
      "description": "Desarrollo local"
    }
  ],
  "tags": [
    { "name": "health", "description": "Estado del servicio" },
    { "name": "users", "description": "Registro, autenticación y perfil" },
    { "name": "payments", "description": "Pagos P2P, links de cobro y saldo" },
    { "name": "topup", "description": "Recargas vía WebPay y Khipu" },
    { "name": "merchants", "description": "Dashboard y liquidaciones para comercios" },
    { "name": "webhook", "description": "Webhook WhatsApp Cloud API" }
  ],
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT"
      }
    },
    "schemas": {
      "Error": {
        "type": "object",
        "properties": {
          "error": { "type": "string" },
          "code": { "type": "string" }
        }
      },
      "UserProfile": {
        "type": "object",
        "properties": {
          "userId": { "type": "string", "format": "uuid" },
          "waId": { "type": "string", "example": "56912345678" },
          "displayName": { "type": "string" },
          "kycLevel": { "type": "string", "enum": ["NONE", "BASIC", "INTERMEDIATE", "FULL"] },
          "createdAt": { "type": "string", "format": "date-time" }
        }
      },
      "WalletBalance": {
        "type": "object",
        "properties": {
          "balance": { "type": "integer", "description": "Saldo en CLP (entero, sin decimales)", "example": 25000 },
          "currency": { "type": "string", "default": "CLP" },
          "kycLevel": { "type": "string" },
          "monthlySpent": { "type": "integer" },
          "monthlyLimit": { "type": "integer" }
        }
      },
      "Transaction": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "reference": { "type": "string", "example": "#WP-2026-A7F3B2" },
          "type": { "type": "string", "enum": ["P2P", "PAYMENT_LINK", "TOPUP_WEBPAY", "TOPUP_KHIPU", "MERCHANT_PAYMENT"] },
          "amount": { "type": "integer", "example": 8500 },
          "fee": { "type": "integer", "example": 0 },
          "status": { "type": "string", "enum": ["PENDING", "COMPLETED", "FAILED", "REVERSED"] },
          "createdAt": { "type": "string", "format": "date-time" }
        }
      },
      "PaymentLink": {
        "type": "object",
        "properties": {
          "code": { "type": "string", "example": "a1B2c3" },
          "url": { "type": "string", "example": "https://whatpay.cl/c/a1B2c3" },
          "amount": { "type": "integer", "example": 15000 },
          "description": { "type": "string" },
          "expiresAt": { "type": "string", "format": "date-time" }
        }
      }
    }
  },
  "paths": {
    "/health": {
      "get": {
        "tags": ["health"],
        "summary": "Health check",
        "description": "Estado del servicio y versión. Usado por Cloud Run y el badge de producción.",
        "security": [],
        "responses": {
          "200": {
            "description": "Servicio operativo",
            "content": {
              "application/json": {
                "example": {
                  "status": "ok",
                  "service": "whatpay-api",
                  "version": "0.1.0",
                  "timestamp": "2026-02-26T00:00:00.000Z",
                  "environment": "production"
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/users/register": {
      "post": {
        "tags": ["users"],
        "summary": "Registrar usuario",
        "description": "Registro inicial. El RUT se encripta con AES-256-GCM en reposo.",
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["waId", "rut", "pin", "displayName"],
                "properties": {
                  "waId": { "type": "string", "description": "Número WhatsApp (ej: 56912345678)" },
                  "rut": { "type": "string", "description": "RUT chileno (ej: 12.345.678-9)" },
                  "pin": { "type": "string", "description": "PIN de 6 dígitos (no secuencial, no repetido)" },
                  "displayName": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "201": { "description": "Usuario creado" },
          "400": { "description": "Datos inválidos o PIN inseguro", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } },
          "409": { "description": "Número ya registrado" }
        }
      }
    },
    "/api/v1/users/login": {
      "post": {
        "tags": ["users"],
        "summary": "Autenticar con PIN",
        "description": "Devuelve JWT con 30 min de expiración. Bloqueo tras 3 intentos fallidos (15 min).",
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["waId", "pin"],
                "properties": {
                  "waId": { "type": "string" },
                  "pin": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "JWT generado",
            "content": {
              "application/json": {
                "example": { "token": "eyJhbGci...", "expiresIn": "30m", "kycLevel": "BASIC" }
              }
            }
          },
          "401": { "description": "PIN incorrecto" },
          "423": { "description": "Cuenta bloqueada por intentos fallidos" }
        }
      }
    },
    "/api/v1/users/profile": {
      "get": {
        "tags": ["users"],
        "summary": "Obtener perfil",
        "security": [{ "bearerAuth": [] }],
        "responses": {
          "200": { "description": "Perfil del usuario", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/UserProfile" } } } },
          "401": { "description": "Token inválido o expirado" }
        }
      }
    },
    "/api/v1/payments/balance": {
      "get": {
        "tags": ["payments"],
        "summary": "Consultar saldo del wallet",
        "security": [{ "bearerAuth": [] }],
        "responses": {
          "200": { "description": "Saldo actual", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/WalletBalance" } } } }
        }
      }
    },
    "/api/v1/payments/pay": {
      "post": {
        "tags": ["payments"],
        "summary": "Enviar pago P2P",
        "description": "Transferencia entre wallets. Usa SELECT FOR UPDATE para prevenir double-spending. P2P es gratis.",
        "security": [{ "bearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["toWaId", "amount", "pin"],
                "properties": {
                  "toWaId": { "type": "string", "description": "Número WhatsApp del destinatario" },
                  "amount": { "type": "integer", "description": "Monto en CLP", "example": 8500 },
                  "pin": { "type": "string", "description": "PIN del emisor para confirmar" },
                  "description": { "type": "string", "description": "Concepto opcional" }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Pago completado",
            "content": {
              "application/json": {
                "example": { "reference": "#WP-2026-A7F3B2", "amount": 8500, "fee": 0, "status": "COMPLETED" }
              }
            }
          },
          "400": { "description": "Monto fuera de límites KYC" },
          "402": { "description": "Saldo insuficiente" },
          "403": { "description": "PIN incorrecto o cuenta bloqueada" }
        }
      }
    },
    "/api/v1/payments/links": {
      "post": {
        "tags": ["payments"],
        "summary": "Crear link de cobro",
        "description": "Genera enlace corto compartible (whatpay.cl/c/{code}). Expira en 24 horas.",
        "security": [{ "bearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["amount"],
                "properties": {
                  "amount": { "type": "integer", "example": 15000 },
                  "description": { "type": "string", "example": "Almuerzo local" },
                  "expiresInHours": { "type": "integer", "default": 24 }
                }
              }
            }
          }
        },
        "responses": {
          "201": { "description": "Link creado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/PaymentLink" } } } }
        }
      }
    },
    "/api/v1/payments/history": {
      "get": {
        "tags": ["payments"],
        "summary": "Historial de transacciones",
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 20 } },
          { "name": "offset", "in": "query", "schema": { "type": "integer", "default": 0 } }
        ],
        "responses": {
          "200": {
            "description": "Lista de transacciones",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "transactions": { "type": "array", "items": { "$ref": "#/components/schemas/Transaction" } },
                    "total": { "type": "integer" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/topup/webpay": {
      "post": {
        "tags": ["topup"],
        "summary": "Iniciar recarga con WebPay",
        "description": "Crea transacción Transbank. Redirige al usuario a la página de pago de Transbank.",
        "security": [{ "bearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["amount"],
                "properties": {
                  "amount": { "type": "integer", "minimum": 1000, "maximum": 500000, "example": 10000 }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Redirección a Transbank",
            "content": {
              "application/json": {
                "example": { "redirectUrl": "https://webpay3g.transbank.cl/...", "token": "e9d555262db0f989...", "amount": 10000 }
              }
            }
          },
          "400": { "description": "Monto fuera del rango $1.000–$500.000" }
        }
      }
    },
    "/api/v1/topup/khipu": {
      "post": {
        "tags": ["topup"],
        "summary": "Iniciar recarga con Khipu",
        "description": "Crea cobro de transferencia bancaria. El usuario paga desde su banco.",
        "security": [{ "bearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["amount"],
                "properties": {
                  "amount": { "type": "integer", "minimum": 1000, "maximum": 500000, "example": 10000 }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "URL de pago Khipu",
            "content": {
              "application/json": {
                "example": { "paymentUrl": "https://khipu.com/payment/...", "paymentId": "a1b2c3d4e5f6", "amount": 10000 }
              }
            }
          }
        }
      }
    },
    "/api/v1/merchants/dashboard": {
      "get": {
        "tags": ["merchants"],
        "summary": "Dashboard del comercio",
        "description": "Resumen de ventas, transacciones pendientes y saldo para liquidar.",
        "security": [{ "bearerAuth": [] }],
        "responses": {
          "200": {
            "description": "Dashboard data",
            "content": {
              "application/json": {
                "example": {
                  "totalSales": 450000,
                  "transactionCount": 23,
                  "pendingSettlement": 125000,
                  "period": "2026-02"
                }
              }
            }
          }
        }
      }
    },
    "/api/v1/webhook": {
      "post": {
        "tags": ["webhook"],
        "summary": "Recibir mensajes de WhatsApp",
        "description": "Endpoint para WhatsApp Cloud API. Deduplicación por message ID en Redis. Procesa mensajes y responde vía BotService.",
        "security": [],
        "requestBody": {
          "description": "WhatsApp webhook payload",
          "content": {
            "application/json": {
              "schema": { "type": "object" }
            }
          }
        },
        "responses": {
          "200": { "description": "Procesado OK" }
        }
      },
      "get": {
        "tags": ["webhook"],
        "summary": "Verificar webhook (Meta challenge)",
        "security": [],
        "parameters": [
          { "name": "hub.mode", "in": "query", "schema": { "type": "string" } },
          { "name": "hub.verify_token", "in": "query", "schema": { "type": "string" } },
          { "name": "hub.challenge", "in": "query", "schema": { "type": "string" } }
        ],
        "responses": {
          "200": { "description": "Challenge devuelto" },
          "403": { "description": "Token incorrecto" }
        }
      }
    }
  }
}
